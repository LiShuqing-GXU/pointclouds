% VIEW_SCAN
%
% @brief    Plots a single scan
%
% @input    S       valid scan struct
function view_scan(S,varargin)
    
    % Auto-create scane from raw points
    if isnumeric(S)
       S = scan('Points',S); 
    end

    % Defaults
    show_map                = false; %ismapped(S);
    show_normals            = false; %issurf(S);
    show_source             = true;
    show_rgb                = (~show_map) && iscolored(S);
    point_color             = 'w';
    normal_color            = 'w';
    background_color        = [0,0,0];
    nvararg                 = numel(varargin);
    markersize              = 5;
    


    hold on 
    for idx = 1:2:nvararg
        if      field(varargin,'NORMALS')
            show_normals    = show_normals && strcmpi( param(varargin,'CHAR') ,'ON');
        elseif  field(varargin,'SOURCE')
            show_source     = strcmpi( param(varargin,'CHAR') ,'ON');
        elseif  field(varargin,'MARKERSIZE')
            markersize      = param(varargin,'DOUBLE');
        elseif  field(varargin,'RGB')
            show_rgb        = strcmpi( param(varargin,'CHAR') ,'ON');
            if is
            if  show_rgb
                point_color = S.colors;
            end
        elseif  field(varargin,'MAP')
            show_map        = strcmpi( param(varargin,'CHAR') ,'ON');
        elseif  field(varargin,'BACKGROUNDCOLOR')
            background_color= param(varargin,'DOUBLE');
        elseif  field(varargin,'POINTCOLOR')
            point_color 	= param(varargin,'DOUBLE');
        elseif  field(varargin,'NORMALCOLOR')
            normal_color 	= param(varargin,'DOUBLE');            
        else
            error(['Unrecognized option : ',varargin{1}]);
        end
        varargin(1:2)       = [];
    end
    
    if  show_map             
        point_color         = S.map;       
    end
    
    hold on
    
    % Show the points
    if  isempty(S)
        warning('Pointcoud is empty. Will not render.');
    else
        
        if  show_map || show_rgb
            scatter3(   S.points(1,:), S.points(2,:), S.points(3,:),    ...
                        markersize,                                     ...
                        transpose(point_color),                         ...
                        'Marker', '.'                                   ...
                   );           
        else
            plot3(      S.points(1,:), S.points(2,:), S.points(3,:),    ...
                        'Marker', '.',                                  ...
                        'MarkerSize', markersize,                       ...
                        'LineStyle', 'none',                            ...
                        'Color',point_color                             ...
                   );  
        end
        
        
        if  show_normals
            quiver3(    S.points(1,:), S.points(2,:), S.points(3,:),    ...
                        S.normals(1,:),S.normals(2,:),S.normals(3,:),   ...
                        markersize,                                     ...
                        'Marker', 'o',                                  ...
                        'MarkerSize', 1.1*markersize,                   ...
                        'LineStyle', 'none',                            ...
                        'Color',normal_color                            ...
                   );  
        end
        
    end
    
    % Show the point-cloud source (sensor base)
    if  show_source
        plot3(0,0,0,'go','MarkerSize',8);
        plot3(0,0,0,'gx','MarkerSize',8);
    end
    hold off

    % Rename the figure
    cleanfig(gcf,   ...
        background_color,    ...
        'Name',     ...
            sprintf('Time : %f | Size : %d | Surface : %s | Colored : %s',...
                S.timestamp,        ...
                size(S),            ...
                YNSTR(issurf(S)),   ...
                YNSTR(iscolored(S)) ...
            )...
        );
end









% Helpers
function str = YNSTR(bool)
    if  bool
        str = 'Yes';
    else
        str = 'No';
    end
end
function b = field(argv,name)
    b = strcmpi(argv{1},name);
end
function str = param(argv,type)
    str = argv{2};
    %if ~strcmpi( class(par), type )
    %   error( sprintf( 'Field [%s] supplied mismatching parameter type [%s].',argv{1},type) ) 
    %end
end